name: Deploy to Production (VPS)

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Setup Node.js for React frontend build
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # Build React frontend
      - name: Build React Frontend
        run: |
          cd frontend
          npm ci
          npm run build

      # Copy React build to Spring Boot static resources
      - name: Copy Frontend to Spring Boot
        run: |
          echo "ðŸ“¦ Cleaning static directory..."
          rm -rf src/main/resources/static/*
          mkdir -p src/main/resources/static
          cp -r frontend/dist/* src/main/resources/static/

          echo "âœ… Verifying build artifacts..."
          ls -la src/main/resources/static/index.html || { echo "âŒ index.html missing!"; exit 1; }
          
          BUNDLE=$(grep -o "index-[^.]*\.js" src/main/resources/static/index.html | head -1)
          echo "ðŸ“¦ Bundle: $BUNDLE"
          ls -la "src/main/resources/static/assets/$BUNDLE" || { echo "âŒ Bundle missing!"; exit 1; }

      # Setup Java and build Spring Boot
      - uses: actions/setup-java@v4
        with: 
          distribution: temurin
          java-version: '17'
          cache: maven

      # Build Spring Boot JAR
      - name: Build Spring Boot JAR
        run: |
          echo "ðŸ”¨ Building Production JAR..."
          mvn clean package -DskipTests -Pprod
          
          echo "âœ… Verifying JAR contents..."
          jar tf target/*.jar | grep "BOOT-INF/classes/static/index.html" || { echo "âŒ index.html not in JAR!"; exit 1; }

      # Build and push Docker image with production tag
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        run: |
          # Build with both latest and git SHA tags
          docker build -t ${{ secrets.DOCKER_USERNAME }}/trip-calculate:latest \
                       -t ${{ secrets.DOCKER_USERNAME }}/trip-calculate:prod-${{ github.sha }} .
          docker push ${{ secrets.DOCKER_USERNAME }}/trip-calculate:latest
          docker push ${{ secrets.DOCKER_USERNAME }}/trip-calculate:prod-${{ github.sha }}

  deploy:
    needs: build
    runs-on: ubuntu-latest  # Use GitHub-hosted runner for VPS deployment
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          echo "${{ secrets.VPS_SSH_KEY }}" > ~/.ssh/vps_deploy_key
          chmod 600 ~/.ssh/vps_deploy_key
          
          if [ -n "${{ secrets.VPS_KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.VPS_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          else
            ssh-keyscan -H ${{ secrets.VPS_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          fi

      - name: Deploy to VPS
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          VPS_HOST: ${{ secrets.VPS_HOST }}
          VPS_USER: ${{ secrets.VPS_USER }}
          DATABASE_URL: ${{ secrets.PROD_DATABASE_URL }}
          DATABASE_USERNAME: ${{ secrets.PROD_DATABASE_USERNAME }}
          DATABASE_PASSWORD: ${{ secrets.PROD_DATABASE_PASSWORD }}
          GOOGLE_CLIENT_ID: ${{ secrets.PROD_GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.PROD_GOOGLE_CLIENT_SECRET }}
          OAUTH_REDIRECT_URI: ${{ secrets.PROD_OAUTH_REDIRECT_URI }}
          GMAIL_USERNAME: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }}
        run: |
          ssh -i ~/.ssh/vps_deploy_key $VPS_USER@$VPS_HOST "DOCKER_USERNAME='${DOCKER_USERNAME}' DATABASE_URL='${DATABASE_URL}' DATABASE_USERNAME='${DATABASE_USERNAME}' DATABASE_PASSWORD='${DATABASE_PASSWORD}' GOOGLE_CLIENT_ID='${GOOGLE_CLIENT_ID}' GOOGLE_CLIENT_SECRET='${GOOGLE_CLIENT_SECRET}' OAUTH_REDIRECT_URI='${OAUTH_REDIRECT_URI}' GMAIL_USERNAME='${GMAIL_USERNAME}' GMAIL_APP_PASSWORD='${GMAIL_APP_PASSWORD}' ADMIN_EMAIL='${ADMIN_EMAIL}' bash -s" <<'REMOTE'
            echo "ðŸš€ Deploying to Production VPS..."
            
            docker pull "${DOCKER_USERNAME}/trip-calculate:latest"
            
            # Stop and remove old container
            docker stop trip-calculate-prod || true
            docker rm trip-calculate-prod || true
            
            # Run new container with production settings
            docker run -d -p 8080:8080 \
              --name trip-calculate-prod \
              --restart unless-stopped \
              -e SPRING_PROFILES_ACTIVE=prod \
              -e DATABASE_URL="${DATABASE_URL}" \
              -e DATABASE_USERNAME="${DATABASE_USERNAME}" \
              -e DATABASE_PASSWORD="${DATABASE_PASSWORD}" \
              -e GOOGLE_CLIENT_ID="${GOOGLE_CLIENT_ID}" \
              -e GOOGLE_CLIENT_SECRET="${GOOGLE_CLIENT_SECRET}" \
              -e OAUTH_REDIRECT_URI="${OAUTH_REDIRECT_URI}" \
              -e GMAIL_USERNAME="${GMAIL_USERNAME}" \
              -e GMAIL_APP_PASSWORD="${GMAIL_APP_PASSWORD}" \
              -e ADMIN_EMAIL="${ADMIN_EMAIL}" \
              "${DOCKER_USERNAME}/trip-calculate:latest"
            
            echo "âœ… Production deployment complete!"
            docker ps -a | grep trip-calculate-prod
            
            # Health check
            sleep 5
            curl -f http://localhost:8080/actuator/health || echo "âš ï¸ Health check failed!"
          REMOTE

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/vps_deploy_key

      - name: Send Deployment Notification
        if: always()
        run: |
          # Optional: Send notification to Telegram/Slack
          echo "ðŸŽ‰ Production deployment completed for commit ${{ github.sha }}"
