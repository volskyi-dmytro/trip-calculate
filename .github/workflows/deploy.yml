name: Deploy Application

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      # Setup Node.js for React frontend build
      - uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'
          cache-dependency-path: frontend/package-lock.json

      # Build React frontend
      - name: Build React Frontend
        run: |
          cd frontend
          npm ci
          npm run build

      # Copy React build to Spring Boot static resources
      - name: Copy Frontend to Spring Boot
        run: |
          echo "ðŸ“¦ Cleaning static directory..."
          rm -rf src/main/resources/static/*

          echo "ðŸ“‚ Creating static directory..."
          mkdir -p src/main/resources/static

          echo "ðŸ“‚ Copying React build to static resources..."
          cp -r frontend/dist/* src/main/resources/static/

          echo "âœ… Verifying index.html copied:"
          ls -la src/main/resources/static/index.html || { echo "âŒ index.html missing!"; exit 1; }

          echo "âœ… Verifying assets directory:"
          ls -la src/main/resources/static/assets/ || { echo "âŒ Assets directory missing!"; exit 1; }

          echo "ðŸŽ¨ Checking for CSS files:"
          find src/main/resources/static -name "*.css" -type f | head -10

          echo "ðŸ“œ Checking for JS files:"
          find src/main/resources/static -name "*.js" -type f | head -10

          echo "ðŸ” Checking for route-planner CSS in bundle:"
          grep -l "route-planner-container" src/main/resources/static/assets/*.css && echo "âœ… Route planner styles found!" || echo "âš ï¸ Route planner styles not found in CSS"

          echo "ðŸ” Checking for Leaflet CSS in bundle:"
          grep -l "leaflet" src/main/resources/static/assets/*.css && echo "âœ… Leaflet styles found!" || echo "âš ï¸ Leaflet styles not found in CSS"

          echo "ðŸ“Š Total files copied:"
          find src/main/resources/static -type f | wc -l

      # Setup Java and build Spring Boot application
      - uses: actions/setup-java@v4
        with: 
          distribution: temurin
          java-version: '17'
          cache: maven
          overwrite-settings: true
          settings-path: ${{ github.workspace }} 

      # Inject settings.xml that mirrors Central to repo1 (often more reliable)
      - name: Write Maven settings.xml
        run: |
          cat > $GITHUB_WORKSPACE/settings.xml <<'XML'
          <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0">
            <mirrors>
              <mirror>
                <id>central-repo1</id>
                <name>Central via repo1</name>
                <url>https://repo1.maven.org/maven2/</url>
                <mirrorOf>central</mirrorOf>
              </mirror>
            </mirrors>
            <profiles>
              <profile>
                <id>http-tuning</id>
                <properties>
                  <maven.wagon.http.retryHandler.count>6</maven.wagon.http.retryHandler.count>
                  <maven.wagon.http.connectionTimeout>30000</maven.wagon.http.connectionTimeout>
                  <maven.wagon.http.readTimeout>30000</maven.wagon.http.readTimeout>
                  <!-- Tame parallel downloads if the network is flaky -->
                  <maven.artifact.threads>5</maven.artifact.threads>
                </properties>
              </profile>
            </profiles>
            <activeProfiles>
              <activeProfile>http-tuning</activeProfile>
            </activeProfiles>
          </settings>
          XML

      # Build Spring Boot JAR with retries and clearer logs
      - name: Build Spring Boot JAR
        run: |
          echo "ðŸ”¨ Building Spring Boot JAR..."
          # simple retry loop (handles transient 502/503/504)
          for i in 1 2 3; do
            mvn -s $GITHUB_WORKSPACE/settings.xml -U -DskipTests package \
              -Dmaven.wagon.http.retryHandler.count=6 \
              -Dmaven.wagon.http.pool=false \
              -Dhttp.keepAlive=false && break || {
                echo "Attempt $i failed; retrying in 10s..."
                sleep 10;
              }
          done

          echo "âœ… Verifying index.html in JAR:"
          jar tf target/*.jar | grep "BOOT-INF/classes/static/index.html" || { echo "âŒ index.html not in JAR!"; exit 1; }

          echo "âœ… Checking for CSS files in JAR:"
          jar tf target/*.jar | grep "\.css$" | head -5 || { echo "âŒ No CSS files in JAR!"; exit 1; }

          echo "âœ… Checking for JS files in JAR:"
          jar tf target/*.jar | grep "\.js$" | head -5 || { echo "âŒ No JS files in JAR!"; exit 1; }

          echo "ðŸ” Verifying route-planner assets in JAR:"
          jar tf target/*.jar | grep "BOOT-INF/classes/static/assets/" | head -10

          echo "ðŸ“¦ JAR file info:"
          ls -lh target/*.jar

      # Build and push Docker image
      - uses: docker/setup-buildx-action@v3
      - uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Build and Push Docker Image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/trip-calculate:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/trip-calculate:latest

  deploy:
    needs: build
    runs-on: self-hosted
    steps:
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          chmod 700 ~/.ssh
          # Setup SSH deploy key from secrets
          echo "${{ secrets.SSH_DEPLOY_KEY }}" > ~/.ssh/tripcalc_deploy_key
          chmod 600 ~/.ssh/tripcalc_deploy_key
          # Add known hosts if provided, otherwise scan from host
          if [ -n "${{ secrets.SSH_KNOWN_HOSTS }}" ]; then
            echo "${{ secrets.SSH_KNOWN_HOSTS }}" > ~/.ssh/known_hosts
          else
            ssh-keyscan -H ${{ secrets.LXC_HOST }} >> ~/.ssh/known_hosts 2>/dev/null
          fi

      - name: Deploy to LXC Container
        env:
          DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
          LXC_HOST: ${{ secrets.LXC_HOST }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          OAUTH_REDIRECT_URI: ${{ secrets.OAUTH_REDIRECT_URI }}
          GMAIL_USERNAME: ${{ secrets.GMAIL_USERNAME }}
          GMAIL_APP_PASSWORD: ${{ secrets.GMAIL_APP_PASSWORD }}
          ADMIN_EMAIL: ${{ secrets.ADMIN_EMAIL }} 
        run: |
          ssh -i ~/.ssh/tripcalc_deploy_key ubuntu@$LXC_HOST "DOCKER_USERNAME='${DOCKER_USERNAME}' DATABASE_URL='${DATABASE_URL}' DATABASE_USERNAME='${DATABASE_USERNAME}' DATABASE_PASSWORD='${DATABASE_PASSWORD}' GOOGLE_CLIENT_ID='${GOOGLE_CLIENT_ID}' GOOGLE_CLIENT_SECRET='${GOOGLE_CLIENT_SECRET}' OAUTH_REDIRECT_URI='${OAUTH_REDIRECT_URI}' bash -s" <<'REMOTE'
            docker pull "${DOCKER_USERNAME}/trip-calculate:latest"
            docker stop trip-calculate-container || true
            docker rm trip-calculate-container || true
            docker run -d -p 8080:8080 \
              --name trip-calculate-container \
              --restart unless-stopped \
              -e DATABASE_URL="${DATABASE_URL}" \
              -e DATABASE_USERNAME="${DATABASE_USERNAME}" \
              -e DATABASE_PASSWORD="${DATABASE_PASSWORD}" \
              -e GOOGLE_CLIENT_ID="${GOOGLE_CLIENT_ID}" \
              -e GOOGLE_CLIENT_SECRET="${GOOGLE_CLIENT_SECRET}" \
              -e OAUTH_REDIRECT_URI="${OAUTH_REDIRECT_URI}" \
              -e GMAIL_USERNAME="${GMAIL_USERNAME}" \
              -e GMAIL_APP_PASSWORD="${GMAIL_APP_PASSWORD}" \
              -e ADMIN_EMAIL="${ADMIN_EMAIL}" \
              "${DOCKER_USERNAME}/trip-calculate:latest"
            docker ps -a | grep trip-calculate || true
          REMOTE

      - name: Cleanup SSH Key
        if: always()
        run: rm -f ~/.ssh/tripcalc_deploy_key
